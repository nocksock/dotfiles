#!/usr/bin/env zsh
export NOX_ACTIONS_ROOT="$HOME/.local/share/nox-menu"
export NOX_CACHE_ROOT="$HOME/.cache/nox-menu"

pick() {
    fd | fuzzel --dmenu --cache "$(cache-path)"
}

cache-path() {
    if [[ ! -d $NOX_CACHE_ROOT ]]; then
	mkdir -p $NOX_CACHE_ROOT
	if [[ $? -ne 0 ]]; then
	    notify-send -u urgent "nox-menu" "Error: could not create cache at $NOX_CACHE_ROOT"
	    exit 1
	fi
    fi

    realpath --relative-to="$HOME" "$(pwd)" | tr '/' '-'
}

run() {
    if [[ -d "$1" ]]; then
	cd "$1"
	exec nox-menu
    fi

    if [[ -x "$1" ]]; then
	exec "$1"
    fi

    notify-send -u urgent "nox-menu" "Error: $1 is neither executable nor directory"
    exit 1
}

# make sure we're in a subdirectory of the actions root
if [[ $(pwd) != $NOX_ACTIONS_ROOT* ]]; then
    cd $NOX_ACTIONS_ROOT
fi

action="${1-$(pick)}" || exit 0
exec run "$action"
