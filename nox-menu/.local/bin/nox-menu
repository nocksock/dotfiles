#!/usr/bin/env zsh
help() {
	cat <<-EOF
	nox-menu

	Usage:
	  nox-menu [--run <path>] [path]

		when path is given, change to that directory before picking action

	Options:
	  --run <path>    Run action at <path> instead of picking one
		--depth <n>     Set search depth (default: 6)
		--h, --help     Show this help message
	EOF
}

export NOX_ACTIONS_ROOT="$DOTDIR/nox-menu/.config/nox-menu/actions"
export NOX_CACHE_ROOT="$HOME/.cache/nox-menu"
default=$NOX_ACTIONS_ROOT

if [[ ! -d $NOX_CACHE_ROOT ]]; then
	mkdir -p $NOX_CACHE_ROOT
	if [[ $? -ne 0 ]]; then
		notify-send -u urgent "nox-menu" "Error: could not create cache at $NOX_CACHE_ROOT"
		exit 1
	fi
fi


zparseopts -D -E -A opts \
	-run:=run_path \
	-depth:=depth \
	-help=h \
	--

if [[ -n $opts[--help] ]]; then
  help
  exit 0
fi

# make sure we're in a subdirectory of the actions root
if [[ $(pwd) != $NOX_ACTIONS_ROOT* ]]; then
    echo "Not in actions root, going to default"
	cd $default
fi

# run specified action directly
if [[ -n $opts[--run] ]]; then
    pwd
    echo $1
    cd $opts[--run]
	ls -la
	exec ./run
fi

# go to specified path or default
if [[ -n $1 ]]; then
	cd ${1}
fi

pick-action() {
	# TODO: use fzf with --fzf flag
	# kitty --single-instance --class=float.md --detach \
	# 	-d "$(pwd)" \
	# 	--hold zsh -c "
	# 		fd -tx --max-depth ${depth:-6} \
	# 			| fzf\
	# 			| xargs -I {} notify-send -t 1000 '{}'
	# 	"

	fd run --max-depth ${depth:-6} \
		| sed "s/\/run//"\
		| fuzzel \
			--dmenu
}

action="$(pick-action)"

if [[ -z $action ]]; then
	# cancelled
	exit 0;
fi

cd $action
exec ./run
