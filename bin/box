#!/usr/bin/env sh
#
# $ box
#    a helper to quickly create local code sandboxes
#

TEMPLATE_DIR="$HOME/code/bleepbloop.git/main/templates/"
TEMPLATES=$(ls -1 $TEMPLATE_DIR)
options=()

for t in $TEMPLATES; do
  options+=(".${t}")
done

options+=(
  "vite"
  "t3"
  "next"
  "empty"
  "pnpm create"
)


choice=$(printf '%s\n' "${options[@]}" | fzf --height 40% --layout=reverse --prompt="select box type: ")
if [[ -z $choice ]]; then
  echo "abort: no choice made."
  exit;
fi

for i in "$@"; do case $i in
  -c|--vscode|--code) VSCODE=1 shift ;;
  -t|--tools) TOOLS=1 shift ;;
  *) DIRNAME="${i#*=}" ;;
esac;
done

if [[ $DIRNAME == ./* ]]; then
  ROOT=$(pwd)
  DIRNAME=${DIRNAME#./}
else
  ROOT="$HOME/code/sandboxes"
  if [[ -z $DIRNAME ]]; then
    DIRNAME="$(random-name | gum input --prompt="name: ")"
  fi

  if [[ -a "$ROOT/$DIRNAME" ]]; then
    action=$(echo "Open\nCancel\nOverwrite")
    case $action in
      "Open")
        cd "$ROOT/$DIRNAME"
        start
        exit 0
      ;;
      # "Overwrite")
      #   rm -rf "$ROOT/$DIRNAME"
      # ;;
      "Cancel")
        exit 0
      ;;
    esac
  fi
fi


if [[ -z $DIRNAME ]]; then
  echo "abort: no name given."
  exit;
fi

FULL_PATH="$ROOT/$DIRNAME"

echo "Creating sandbox in $FULL_PATH"

cd $ROOT

case ${choice%%:*} in
  "vite") 
    pnpm create vite $DIRNAME
    ;;
  "next") 
    pnpm create next-app $DIRNAME
    ;;
  "t3") 
    pnpm create t3-app $DIRNAME
    ;;
  "empty")
    mkdir $DIRNAME
    ;;
  "pnpm create")
    read -p "pnpm create: " pnpm_create
    pnpm create $pnpm_create $DIRNAME
    choice="pnpm create $pnpm_create"
    ;;
  *)
    template=${choice#.*}
    # git clone file://$TEMPLATE_DIR$template $DIRNAME --depth=1
    cp -r $TEMPLATE_DIR$template $DIRNAME
    cd $FULL_PATH
    if [[ -a ".env.example" ]]; then
      cp .env.example .env
    fi
    ;;
esac

cd $FULL_PATH

if [[ -f "package.json" ]]; then
  pnpm install
fi

git init
git add . 
git commit -m "feat($DIRNAME): start from $choice"

if [[ -n $TMUX ]]; then
  tmux new-session -s $DIRNAME -c $FULL_PATH -d "zsh -c 'nvim .'"
  tmux switch-client -t $selected_name
else
  kitty @ launch --cwd=$FULL_PATH --type=tab --title=$DIRNAME zsh -c "nvim ."
fi
