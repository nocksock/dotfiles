#!/usr/bin/env sh
#
# $ box
#    a helper to quickly create local code sandboxes
#
# TODO: use relative path when NAME was provided and skip STAMP suffic

if [[ $# -eq 1 ]]; then
  NAME=$1
  DIRNAME=$1
  ROOT=$(pwd)
  if [[ -a "$ROOT/$DIRNAME" ]]; then
    echo "$DIRNAME already exists"
    exit 1;
  fi
else
  NAME=$(gum input --prompt="name: ")
  DIRNAME="${NAME}-$(date +"%Y%m%d%H%M%S")"
  ROOT="$HOME/code/sandboxes"
fi

FULL_PATH="$ROOT/$DIRNAME"

if [[ -z $NAME ]]; then
  exit;
fi

RECIPE=$(cat <<EOF | fzf
template
vite
t3
empty
EOF
)

cd $ROOT

if [[ -z $RECIPE ]]; then
  exit;
fi

case $RECIPE in
  template)
    TEMPLATE=$(find $HOME/code/templates -type d -depth 1 | fzf)
    git clone file://$TEMPLATE $DIRNAME --depth=1
    cd $FULL_PATH
    rm -rf .git
    ;;
  vite) 
    pnpm create vite $DIRNAME
    ;;
  t3) 
    pnpm create t3-app $DIRNAME
    ;;
  empty) 
    mkdir -p $FULL_PATH
    ;;
esac

cd $FULL_PATH


case $RECIPE in
  react|vanilla)
    pnpm add lodash ramda jotai date-fns @faker-js/faker
    pnpm add -D tailwindcss postcss autoprefixer @types/lodash @types/ramda
    pnpm run tailwindcss init -p
  ;; 
  t3)
    pnpm add lodash ramda jotai date-fns @faker-js/faker
    pnpm add -D @types/lodash @types/ramda
  ;;
esac

pnpm install

git init
git add . 
git commit -m "-- start --"

tmux new-session -ds $DIRNAME -c $FULL_PATH

tmux send-keys -t $DIRNAME:1.1 "nvim" Enter

if [[ $RECIPE != "empty" ]]; then
  tmux split-window -t $DIRNAME:1.1 -p 25
  tmux send-keys -t $DIRNAME:1.2 "pnpm dev" Enter
  tmux select-pane -t $DIRNAME:1.1
fi

if [[ -z $TMUX ]]; then
    tmux attach -t $selected_name
else
    tmux switch-client -t $selected_name
fi
