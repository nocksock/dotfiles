# vim:foldmethod=marker:foldlevel=0

# zmodload zsh/zprof # profile startup time

export TERM=xterm-kitty
export EDITOR=nvim
# export PAGER="nvim +Man! -R"
# export MANPAGER='nvim +Man!'
export HOMEBREW_NO_AUTO_UPDATE=1
export SBOX_DIR="$HOME/code/sandboxes/"
export SBOX_PATHS=(
    "$HOME/code/sandboxes"
    "$HOME/code/bleepbloop.git/main/packages"
    "$HOME/code/bleepbloop.git/main/apps"
)

# {{{ compinit

autoload -Uz compinit
# autoload -U +X bashcompinit && bashcompinit

if [[ ! -f ~/.zcompdump ]] ; then
    compinit
        # bashcompinit
        echo "refreshed completions"
else
        compinit -C
        # bashcompinit -C
fi

# brew completions {{{ 

if [[ -n `command -v brew` ]]; then
COMPLETION_DIRS=(
        "$(brew --prefix)/share/zsh/site-functions"
)
fi

for compdir in "${COMPLETION_DIRS[@]}"; do
        fpath+=("$compdir")
        autoload -Uz "$compdir"
done

# }}}
# {{{ 1password completion

if [[ -n `command -v op` ]]; then
        eval "$(op completion zsh)"
        compdef _op op
fi 

# }}}

# }}}
# {{{ keybinds

function _fg() {
        if [[ $(jobs | wc -l) -gt 0 ]]; then
                fg
        else
                tm-select
        fi
}

function _glow() {
        if [[ -n `command -v glow` ]]; then
                glow
        else
                echo "glow not installed"
        fi
}

function _cp-last() {
        echo !! | pbcopy
}

autoload -U edit-command-line
autoload -U select-word-style
zle -N edit-command-line # Emacs style
zle -N tm-p
zle -N _fg
zle -N _glow
zle -N _cp-last 
bindkey -e                       # use emacs keybindings
bindkey '^f' edit-command-line #  like nvim command-mode
bindkey "^[" vi-cmd-mode         # use esc to enter vi-cmd-mode
bindkey "\e[15~" _glow         # use esc to enter vi-cmd-mode
bindkey "^g" _cp-last
bindkey -M emacs '^P' history-substring-search-up
bindkey -M emacs '^N' history-substring-search-down
bindkey -M emacs '^Z' _fg
bindkey -M emacs '^S' tm-s
bindkey -M emacs '^J' accept-and-hold
bindkey '^[[A' history-substring-search-up
bindkey '^[[B' history-substring-search-down
bindkey -M emacs '^N' history-substring-search-down
bindkey -M vicmd 'k' history-substring-search-up
bindkey -M vicmd 'j' history-substring-search-down

export WORDCHARS="*?_.[]~!#$%^(){}<>" # removed =/&;.-

# }}}
# switch from bar to block depending on input mode {{{

set show-mode-in-prompt on
set vi-cmd-mode-string "\1\e[2 q\2"
set vi-ins-mode-string "\1\e[6 q\2"

# }}}
# {{{ history settings
setopt INC_APPEND_HISTORY
setopt HIST_IGNORE_DUPS
setopt EXTENDED_HISTORY
setopt SHARE_HISTORY

export HISTFILE=~/.zsh_history
export HISTSIZE=999999
export SAVEHIST=999999
# }}}
# {{{ CDPATH

declare -U CDPATH cdpath
cdpath=(
        "$HOME"
        "$HOME/code"
        "$HOME/code/bleepbloop.git/main/apps"
        "$cdpath[@]"
)
export CDPATH

# }}}
# {{{ NNN

export NNN_BMS="c:$HOME/code/;d:$HOME/code/dotfiles;n:$HOME/code/dotfiles/;b:$HOME/code/bleepbloop.studio/"
export NNN_FCOLORS='00001e310000000000000000'
export NNN_PLUG='o:!open $nnn;p:preview-tui;v:viu;x:!chmod +x $nnn'
export NNN_FIFO=/tmp/nnn.fifo

# }}}
# {{{ FZF

# check if fzf is installed
if ! command -v fzf &> /dev/null; then
    style -fg yellow "Warning: fzf was not found!"
    return
fi

export FZF_OPTS=(
  "-m"
  "--bind ctrl-j:down,ctrl-k:up"
  "--bind ctrl-d:preview-half-page-down,ctrl-u:preview-half-page-up"
  "--bind ctrl-a:select-all,ctrl-t:toggle-all"
  "--bind ctrl-s:toggle-sort,ctrl-r:toggle-preview,ctrl-/:toggle-search"
)
export FZF_DEFAULT_COMMAND='rg --files --follow --hidden'
export FZF_DEFAULT_OPTS="$FZF_OPTS"

export FZF_CTRL_T_COMMAND="$FZF_DEFAULT_COMMAND"
export FZF_CTRL_T_OPTS="--preview 'bat -pf --line-range :999 {}' --bind='ctrl-o:execute(nvim {})'"

if [[ $OSTYPE == darwin* ]]; then
  test -f /opt/homebrew/opt/fzf/shell/completion.zsh   \
    && source /opt/homebrew/opt/fzf/shell/completion.zsh
  test -f /opt/homebrew/opt/fzf/shell/key-bindings.zsh \
    && source /opt/homebrew/opt/fzf/shell/key-bindings.zsh

        source $(brew --prefix asdf)/libexec/asdf.sh
fi

if [[ $OSTYPE == linux-gnu ]]; then
  test -f /usr/share/doc/fzf/examples/completion.zsh   \
    && source /usr/share/doc/fzf/examples/completion.zsh
  test -f /usr/share/doc/fzf/examples/key-bindings.zsh \
    && source /usr/share/doc/fzf/examples/key-bindings.zsh
fi

# }}}

eval "$(starship init zsh)"
eval "$(direnv hook zsh)"
eval "$(zoxide init zsh)"
source <(fzf --zsh) 

if [[ -n $KITTY_PID ]]; then
        alias ssh="kitty +kitten ssh"
fi

# pnpm
export PNPM_HOME="$HOME/Library/pnpm"
case ":$PATH:" in
  *":$PNPM_HOME:"*) ;;
  *) export PATH="$PNPM_HOME:$PATH" ;;
esac
# pnpm end

# things that must not be in git
if [[ -f "$HOME/.zsh_secrets" ]]; then
        source "$HOME/.zsh_secrets"
fi


eval "$(atuin init zsh --disable-up-arrow)"

alias ls='eza'
alias ll='ls -lah'
# zprof # show profiling result
